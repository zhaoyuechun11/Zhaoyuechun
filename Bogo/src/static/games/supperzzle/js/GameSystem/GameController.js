var GameController=function(){function e(){this.mLineArray=[],this.mDoEmpty=[],this.mComboTime=0,this.mComboNum=0,this.candyClearNum=0,this.delayTime=100,this.isRepeatLoop=!1,this.roleAni=new Laya.Animation,this.points=[],this.mGameMode=new GameMode,this.AddListener()}return e.prototype.AddListener=function(){EventManage.Instance().AddListener(EventEnum.preLoad_complete,this.EnterGame.bind(this)),EventManage.Instance().AddListener(EventEnum.game,this.Processor.bind(this)),EventManage.Instance().AddListener(EventEnum.net_update_score,this.NetUpdateScore.bind(this)),EventManage.Instance().AddListener(EventEnum.net_user_info,this.NetUserInfo.bind(this))},e.prototype.Test=function(){},e.prototype.EnterGame=function(){this.mGameView=new GameView,GameManage.Instance().mRoot.addChild(this.mGameView),Common.AddClickListener(this.mGameView.testBtn,this.Test.bind(this),!1),this.roleAni.loadImages(this.aniUrls("ax",22)),this.roleAni.on(Laya.Event.COMPLETE,this,this.onComplete),this.roleAni.visible=!1,this.roleAni.pivotX=128,this.roleAni.pivotY=128,this.roleAni.scale(.7,.7,!1),this.roleAni.pos(365,134),this.mGameView.addChild(this.roleAni),Laya.timer.loop(4500,this,this.LinkTip)},e.prototype.ResetGame=function(){this.candyClearNum=0,Laya.timer.clearAll(this),this.roleAni.removeSelf(),this.mGameView.destroy(),this.EnterGame()},e.prototype.Processor=function(e,i){switch(e){case"selected":this.Processor2selected(i)}},e.prototype.aniUrls=function(e,i){for(var t=[],n=0;n<i;n++)t.push("Frame/"+e+(n+1)+".png");return t},e.prototype.Processor2selected=function(e){var i=this;if(null!=this.mTipFirst&&(this.mTipFirst.img_shine_bg.visible=!1,this.mTipSecond.img_shine_bg.visible=!1),Laya.timer.clear(this,this.loopAnimate1),this.isRepeatLoop=!1,Laya.timer.loop(2500,this,this.LinkTip),null==this.mSelected)e.setSelected(!0),e.img_shine_bg.visible=!0,this.mTween=Laya.Tween.to(e.icon,{scaleX:1.2,scaleY:1.2},500,Laya.Ease.elasticOut),e.img_shine_bg.scaleX=1.73,e.img_shine_bg.scaleY=1.73,Laya.timer.frameLoop(1,this,this.loopAnimate,[e]),this.mSelected=e,this.mSecondSelected=null,Laya.SoundManager.playSound("sounds/dida.mp3",1);else{this.mSecondSelected=e;if(this.IsCheckLinked(this.mSelected,e)){Laya.SoundManager.playSound("sounds/tgxc.mp3",1);var t=Date.parse((new Date).toString());t-this.mComboTime<2500&&0!=this.mComboTime?(Laya.SoundManager.playSound("sounds/combo1.mp3",1),this.mComboNum+=1,this.mGameView.lbl_combo_num.text=this.mComboNum+"",this.mGameView.lbl_combo_num.visible=!0,this.mGameView.img_combo.visible=!0,this.mGameView.lbl_combo_num.scaleX=0,this.mGameView.lbl_combo_num.scaleY=0,this.mGameView.img_combo.scaleX=0,this.mGameView.img_combo.scaleY=0,Laya.Tween.to(this.mGameView.lbl_combo_num,{scaleX:1,scaleY:1},800,Laya.Ease.elasticOut,null,0,!0,!0),Laya.Tween.to(this.mGameView.img_combo,{scaleX:1,scaleY:1},800,Laya.Ease.elasticOut,null,0,!0,!0),Laya.timer.clear(this,this._loop),Laya.timer.once(2500,this,this._loop),this.mGameView.aniBoom.play(0,!1),this.mGameView.aniBoom.on(laya.events.Event.COMPLETE,this,function(){i.mGameView.aniBoom.removeSelf()})):this.mComboNum=0,this.mComboTime=t,this.mTween=Laya.Tween.to(e.icon,{scaleX:1.2,scaleY:1.2},500,Laya.Ease.elasticOut),e.img_shine_bg.visible=!0,Laya.timer.frameLoop(1,this,this.loopAnimate,[e,this.mSelected]),e.img_shine_bg.scaleX=1.73,e.img_shine_bg.scaleY=1.73,e.setSelected(!0);var n=!0;n?(this.mDoEmpty.push(this.mSelected),this.mDoEmpty.push(this.mSecondSelected),n=!1):Laya.timer.once(this.delayTime,this,function(){i.mDoEmpty.push(i.mSelected),i.mDoEmpty.push(i.mSecondSelected)}),this.Connect(this.points,this.ConnectOver.bind(this));var s=new AniView;this.mGameView.addChild(s);var o=new AniView;this.mGameView.addChild(o),s.pos(e.x-85,e.y+73),s.start(),o.pos(this.mSelected.x-85,this.mSelected.y+73),o.start(),this.mSelected=null,this.mSecondSelected=null}else Laya.SoundManager.playSound("sounds/dida.mp3",1),this.mTween.complete(),this.mSelected.setSelected(!1),this.mSelected.img_shine_bg.visible=!1,this.mSelected.icon.scaleX=1,this.mSelected.icon.scaleY=1,e.setSelected(!0),e.img_shine_bg.visible=!0,this.mTween=Laya.Tween.to(e.icon,{scaleX:1.2,scaleY:1.2},500,Laya.Ease.elasticOut),Laya.timer.frameLoop(1,this,this.loopAnimate,[e]),e.img_shine_bg.scaleX=1.73,e.img_shine_bg.scaleY=1.73,this.mSelected=e}},e.prototype._loop=function(){var e=this;Laya.Tween.to(this.mGameView.lbl_combo_num,{scaleX:0,scaleY:0},500,Laya.Ease.strongOut,Laya.Handler.create(this,function(){e.mGameView.lbl_combo_num.visible=!1})),Laya.Tween.to(this.mGameView.img_combo,{scaleX:0,scaleY:0},500,Laya.Ease.strongOut,Laya.Handler.create(this,function(){e.mGameView.img_combo.visible=!1}))},e.prototype.onComplete=function(){this.roleAni.visible=!1},e.prototype.loopAnimate=function(e,i){e.img_shine_bg.rotation+=3,null!=i&&(i.img_shine_bg.rotation+=3)},e.prototype.ConnectOver=function(){var e=this;console.log(this.mSelected);for(var i=0;i<this.mDoEmpty.length;i++)this.mDoEmpty[i].SetClear(),this.mGameView.mPatternList.splice(this.mGameView.mPatternList.indexOf(this.mDoEmpty[i]),1);Laya.timer.once(this.delayTime,this,function(){for(i=0;i<e.mDoEmpty.length;i++)e.mDoEmpty[i].SetEmpty();e.mDoEmpty=[],e.IsCheckLock();for(var i=0;i<e.mLineArray.length;i++)e.mLineArray[i].destroy()});var t=Math.floor(100*(this.candyClearNum+=2/this.mGameView.candySum));MessageProxy.Instance().SendPostScore(t),this.IsCheckGameOver()&&Laya.SoundManager.stopMusic()},e.prototype.ConsoleLogPoints=function(e){console.log("points:");for(var i=0;i<e.length;i++)console.log("["+e[i].xIndex+","+e[i].yIndex+"]")},e.prototype.CheckPoint=function(e){return!e.icon.visible},e.prototype.IsCheckLinked=function(e,i){return e.icon.source==i.icon.source&&(this.points=[],this.LineLink(e,i)?(this.points.unshift(e),this.points.push(i),this.ConsoleLogPoints(this.points),console.log("1线"),!0):this.LineLinkTwo(e,i)?(this.points.unshift(e),this.points.push(i),this.ConsoleLogPoints(this.points),console.log("2线"),!0):!!this.LineLinkThree(e,i)&&(this.points.unshift(e),this.points.push(i),this.ConsoleLogPoints(this.points),console.log("3线"),!0))},e.prototype.LineLink=function(e,i){if(e.xIndex!=i.xIndex&&e.yIndex!=i.yIndex)return!1;if(Math.abs(e.xIndex-i.xIndex)+Math.abs(e.yIndex-i.yIndex)<=1)return!0;if(e.xIndex==i.xIndex){for(var t=Math.abs(e.yIndex-i.yIndex),n=e.yIndex<i.yIndex?e:i,s=1;s<t;s++)if(!this.CheckPoint(this.mGameMode.checkerboard[n.xIndex][n.yIndex+s]))return!1;return!0}if(e.yIndex==i.yIndex){for(var o=Math.abs(e.xIndex-i.xIndex),n=e.xIndex<i.xIndex?e:i,s=1;s<o;s++)if(!this.CheckPoint(this.mGameMode.checkerboard[n.xIndex+s][n.yIndex]))return!1;return!0}},e.prototype.LineLinkTwo=function(e,i){if(e.xIndex==i.xIndex||e.yIndex==i.yIndex)return!1;var t=this.mGameMode.checkerboard[e.xIndex][i.yIndex],n=this.mGameMode.checkerboard[i.xIndex][e.yIndex];return this.CheckPoint(t)&&this.LineLink(e,t)&&this.LineLink(i,t)?(this.points.push(t),!0):!!(this.CheckPoint(n)&&this.LineLink(e,n)&&this.LineLink(i,n))&&(this.points.push(n),!0)},e.prototype.LineLinkThree=function(e,i){for(var t=[],n=e.xIndex-1;n>=0;n--){s=this.mGameMode.checkerboard[n][e.yIndex];if(!this.CheckPoint(s))break;t.push(s)}for(n=e.xIndex+1;n<this.mGameMode.horizontalCount;n++){s=this.mGameMode.checkerboard[n][e.yIndex];if(!this.CheckPoint(s))break;t.push(s)}for(n=e.yIndex-1;n>=0;n--){s=this.mGameMode.checkerboard[e.xIndex][n];if(!this.CheckPoint(s))break;t.push(s)}for(n=e.yIndex+1;n<this.mGameMode.verticalCount;n++){var s=this.mGameMode.checkerboard[e.xIndex][n];if(!this.CheckPoint(s))break;t.push(s)}for(n=0;n<t.length;n++)if(this.LineLinkTwo(t[n],i))return this.points.unshift(t[n]),!0;return!1},e.prototype.Connect=function(e,i){console.log(e.length);var t=e.shift();0!=e.length?this.DrawLink(new Laya.Point(t.x+t.icon.x,t.y+t.icon.y),new Laya.Point(e[0].x+e[0].icon.x,e[0].y+e[0].icon.y)):i()},e.prototype.DrawLink=function(e,i){var t=new Laya.Clip;t.skin="Frame/sd1.png",this.mGameView.checkerboard.addChild(t),this.mLineArray.push(t),t.x=e.x,t.y=e.y,t.width=0,t.height=0,t.clipWidth=1,t.anchorY=.5;var n=0;e.x>i.x?t.rotation=180:e.y<i.y?(t.rotation=90,n=8,t.y-=n):e.y>i.y&&(t.rotation=-90,n+=8,t.y+=n);var s=Math.abs(e.x-i.x)+Math.abs(e.y-i.y)+1.7*n,o=3;Laya.timer.loop(20,this,function(){o<10&&(o+=1,t.skin="Frame/sd"+Math.floor(o%4)+".png")}),laya.utils.Tween.to(t,{clipWidth:s},5,null,Laya.Handler.create(this,this.Connect,[this.points,this.ConnectOver.bind(this)]))},e.prototype.IsCheckLock=function(){if(this.mGameMode.checkerboard.length>9)return!1;for(var e=[],i=0;i<this.mGameMode.checkerboard.length;i++)for(t=0;t<this.mGameMode.checkerboard[i].length;t++)this.mGameMode.checkerboard[i][t].isClear&&e.push(this.mGameMode.checkerboard[i][t]);for(i=0;i<e.length;i++)for(var t=i+1;t<e.length;t++)if(this.IsCheckLinked(e[i],e[t]))return!1;for(;e.length>0;){var n="Icon/"+Common.Random(7)+".png",s=e[Common.Random(e.length-1)];e.splice(e.indexOf(s),1);var o=e[Common.Random(e.length-1)];1==e.length&&(o=e[0]),e.splice(e.indexOf(o),1),s.SetIcon(n),o.SetIcon(n),s.isClear=!0,o.isClear=!0}return!0},e.prototype.LinkTip=function(){if(1!=this.isRepeatLoop)for(var e=0;e<this.mGameView.mPatternList.length;e++)for(var i=e+1;i<this.mGameView.mPatternList.length;i++)if(this.IsCheckLinked(this.mGameView.mPatternList[e],this.mGameView.mPatternList[i]))return this.mTipFirst=this.mGameView.mPatternList[e],this.mTipSecond=this.mGameView.mPatternList[i],this.mTipFirst.img_shine_bg.scale(1.7,1.7),this.mTipSecond.img_shine_bg.scale(1.7,1.7),this.mTipFirst.img_shine_bg.visible=!0,this.mTipSecond.img_shine_bg.visible=!0,void Laya.timer.frameLoop(1,this,this.loopAnimate1,[this.mTipFirst,this.mTipSecond])},e.prototype.loopAnimate1=function(e,i){e!=this.mSelected&&(e.img_shine_bg.rotation+=3),null!=i&&i!=this.mSelected&&(i.img_shine_bg.rotation+=3),this.isRepeatLoop=!0},e.prototype.IsCheckGameOver=function(){for(var e=0;e<this.mGameMode.checkerboard.length;e++)for(var i=0;i<this.mGameMode.checkerboard[e].length;i++)if(this.mGameMode.checkerboard[e][i].isClear)return!1;return!0},e.prototype.NetUpdateScore=function(e){this.mGameView.SetScore(e.id,e.score/100),e.id>0&&e.score/100==.7||e.score/100==.8||e.score/100==.9?this.roleAni.play(null,!1):e.id>0&&e.score},e.prototype.NetUserInfo=function(e){console.log(e.data),this.mGameView.playerName1.text=e.data[0].userName,this.mGameView.playerName2.text=e.data[1].userName,this.mGameView.img_player1_icon.skin=e.data[0].userHead,this.mGameView.img_player2_icon.skin=e.data[1].userHead,this.mGameView.p1_head_border.skin=e.data[0].userHeadFrame,this.mGameView.p2_head_border.skin=e.data[1].userHeadFrame},e}();