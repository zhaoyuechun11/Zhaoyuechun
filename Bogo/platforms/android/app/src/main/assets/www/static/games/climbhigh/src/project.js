window.__require=function e(t,o,n){function i(s,c){if(!o[s]){if(!t[s]){var r=s.split("/");if(r=r[r.length-1],!t[r]){var d="function"==typeof __require&&__require;if(!c&&d)return d(r,!0);if(a)return a(r,!0);throw new Error("Cannot find module '"+s+"'")}}var p=o[s]={exports:{}};t[s][0].call(p.exports,function(e){return i(t[s][1][e]||e)},p,p.exports,e,t,o,n)}return o[s].exports}for(var a="function"==typeof __require&&__require,s=0;s<n.length;s++)i(n[s]);return i}({ClimbPoint:[function(e,t,o){"use strict";cc._RF.push(t,"94b5aDyDsJIK69LOb0m0ZtN","ClimbPoint"),Object.defineProperty(o,"__esModule",{value:!0});var n=cc._decorator,i=n.ccclass,a=(n.property,function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.dropDown=function(){var e=this,t=cc.sequence(cc.moveBy(3,0,this.node.y-this.node.parent.parent.height/2-this.node.height).easing(cc.easeOut(1)),cc.callFunc(function(){e.node.active=!1}));this.node.runAction(t)},t.prototype.start=function(){},t=__decorate([i],t)}(cc.Component));o.default=a,cc._RF.pop()},{}],GameSocket:[function(e,t,o){"use strict";cc._RF.push(t,"40a0cN3UX1DWqcelYu5mw3E","GameSocket"),Object.defineProperty(o,"__esModule",{value:!0});var n=function(){function e(e,t){this.timeOutHandle=null,this.retryCount=0,this.host=e,this.port=t}return e.prototype.connect=function(e){var t=this,o=this;this.socket=new WebSocket("ws://"+this.host+":"+this.port),this.socket.onclose=function(e){console.log("GameSocket","onClose",e),o.onClose(),o.timeOutHandle&&(clearTimeout(o.timeOutHandle),o.timeOutHandle=null)},this.socket.onerror=function(o){console.log("GameSocket","onError",o),t.retryCount>=3?t.onClose():setTimeout(function(){t.retryCount++,t.connect(e)},.5)},this.socket.onmessage=function(e){if(console.log("GameSocket","onMessage",e.data),"pi"!==e.data){var t=JSON.parse(e.data);switch(t.type){case"begin":o.onBegin(t.msg.countdown,t.msg.mappointer);break;case"over":o.onOver(t.msg.reason);break;case"move":o.onMove(t.msg.step)}}},this.socket.onopen=function(t){console.log("GameSocket","onOpen"),o.heartCheck(),e()}},e.prototype.heartCheck=function(){var e=this;this.timeOutHandle&&clearTimeout(this.timeOutHandle),this.timeOutHandle=setInterval(function(){e.socket.send("pi")},5e3)},e.prototype.send=function(e){this.socket.send(JSON.stringify(e))},e.prototype.init=function(e){console.log("GameSocket","init"),this.send({type:"init",msg:{id:"climbhigh",name:"Climb High",userid:e[0].toString(),userlist:e.map(function(e){return e.toString()})}})},e.prototype.ready=function(){console.log("GameSocket","ready"),this.send({type:"ready",msg:{}})},e.prototype.move=function(e){console.log("GameSocket","move"),this.send({type:"move",msg:{step:e}})},e.prototype.mapindex=function(e){console.log("GameSocket","mapindex"),this.send({type:"mapindex",msg:e})},e.prototype.temp=function(e){console.log("GameSocket","temp"),this.send({type:"temp",msg:e})},e.prototype.disconnect=function(){this.socket.close()},e}();o.default=n,cc._RF.pop()},{}],GameView:[function(e,t,o){"use strict";cc._RF.push(t,"e1b90/rohdEk4SdmmEZANaD","GameView"),Object.defineProperty(o,"__esModule",{value:!0});var n=e("./Player"),i=e("./ClimbPoint"),a=e("./MessageComponent"),s=e("./GameSocket"),c=cc._decorator,r=c.ccclass,d=c.property,p=(function(){}(),function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.user1=null,t.user2=null,t.headFrame=null,t.headFrame2=null,t.progress1=null,t.progress2=null,t.gameTimer=null,t.playerLeft=null,t.playerRight=null,t.background=null,t.pointPrefab=null,t.pointPrefab2=null,t.gameCountDown=90,t.climbNodes=[],t.climbNodes2=[],t.fakeNodes=[],t.fakeNodes2=[],t.player=null,t.player2=null,t.playerPos=0,t.playerPos2=0,t.playerXSum=0,t.isOver=!1,t.stackCount=0,t.yindaoAction=cc.sequence(cc.moveBy(.25,-50,0),cc.moveBy(.25,50,0)).easing(cc.easeInOut(2)).repeatForever(),t.startCount=0,t}return __extends(t,e),t.prototype.onLoad=function(){var t=this;e.prototype.onLoad.call(this),cc.loader.loadRes("texture/bg_top",cc.SpriteFrame,function(e,o){console.log("loadRes",e,o),t.background.node.getChildByName("bg_top").getComponent(cc.Sprite).spriteFrame=o})},t.prototype.start=function(){0},t.prototype.onGameBegin=function(e,t){var o=this,n=this.node.getChildByName("ui-bg").getChildByName("nameLeft").getComponent(cc.Label),i=this.node.getChildByName("ui-bg").getChildByName("nameRight").getComponent(cc.Label);n.string=e[0].userName,i.string=e[1].userName,n.node.active=!0,i.node.active=!0,this.socket=new s.default(t.url,t.port),this.socket.onBegin=function(e,t){console.log("GameSocket","\u6e38\u620f\u5f00\u59cb",e),e&&(o.gameCountDown=e-1),o.onReceiveMapData(t.ptr1,t.ptr2),o.gameStart()},this.socket.onMove=function(e){console.log("GameSocket","\u63a5\u6536\u5230\u73a9\u5bb62\u79fb\u52a8",e),o.onPlayer2Move(e)},this.socket.onOver=function(t){console.log("GameSocket","\u6e38\u620f\u7ed3\u675f",t),"win"==t?o.sendGameData(1):"timeout"==t?(o.sendGameData(1),e[1].isRobot&&o.sendGameData(1,e[1].userId)):(o.sendGameData(0),e[1].isRobot&&o.sendGameData(1,e[1].userId))},this.socket.onClose=function(){},this.socket.connect(function(){o.socket.init(e.map(function(e){return e.isRobot?"&bot;":e.userId})),o.checkStart()}),cc.loader.load(e[0].userHead,function(e,t){e||(o.user1.node.active=!0,o.user1.spriteFrame=new cc.SpriteFrame(t))}),cc.loader.load(e[1].userHead,function(e,t){e||(o.user2.node.active=!0,o.user2.spriteFrame=new cc.SpriteFrame(t))}),e[0].userHeadFrame&&cc.loader.load(e[0].userHeadFrame,function(e,t){e||(o.headFrame.node.active=!0,o.headFrame.spriteFrame=new cc.SpriteFrame(t))}),e[1].userHeadFrame&&cc.loader.load(e[1].userHeadFrame,function(e,t){e||(o.headFrame2.node.active=!0,o.headFrame2.spriteFrame=new cc.SpriteFrame(t))}),this.playerLeft.zIndex=1,this.playerRight.zIndex=1,this.playerXSum=this.playerLeft.position.x+this.playerRight.position.x,e[0].userId<e[1].userId?(this.player=this.playerLeft,this.player2=this.playerRight):(this.player=this.playerRight,this.player2=this.playerLeft),this.progress1.node.width=0,this.progress2.node.width=0;var a=this.player==this.playerLeft?864:-864;this.background.node.setPosition(this.background.node.position.x+a,this.background.node.position.y),this.readyGo()},t.prototype.readyGo=function(){var e=this;cc.loader.loadRes("sound/readygo",cc.AudioClip,function(t,o){var n=e.node.getChildByName("ready"),i=e.node.getChildByName("go");n.active=!0,n.scale=0,n.runAction(cc.sequence(cc.scaleTo(.3,1).easing(cc.easeIn(2)),cc.delayTime(.3),cc.scaleTo(.3,0).easing(cc.easeOut(2)),cc.callFunc(function(){n.active=!1,i.active=!0,i.scale=0,i.runAction(cc.sequence(cc.delayTime(.3),cc.scaleTo(.3,1).easing(cc.easeIn(2)),cc.delayTime(.8),cc.scaleTo(.3,0).easing(cc.easeOut(2)),cc.callFunc(function(){i.active=!1,e.checkStart()})))}))),cc.audioEngine.play(o,!1,1)})},t.prototype.checkStart=function(){this.startCount++,this.startCount>=2&&this.socket.ready()},t.prototype.onGameOver=function(e){cc.audioEngine.stopAll(),this.socket.disconnect(),this.isOver=!0;var t=this.node.getChildByName(1==e?"win":0==e?"tie":"fail");t.scale=0,t.active=!0,t.runAction(cc.scaleTo(1,1).easing(cc.easeBackOut()))},t.prototype.onBroadcast=function(e){},t.prototype.onPlayer2Move=function(e){-1==e?this.player2.getComponent(n.default).dropDown():(this.playerPos2=e,this.progress2.node.width=231*this.playerPos2/this.climbNodes2.length,this.player2.getComponent(n.default).climbSuccess(this.climbNodes2[e-1].position))},t.prototype.onReceiveMapData=function(e,t){this.player==this.playerRight?(this.climbNodes2=this.generatePointsByPos(e),this.fakeNodes2=this.generateFakePointsByPos(t),this.climbNodes=this.generatePointsRight(this.climbNodes2),this.fakeNodes=this.generateFakePointsRight(this.fakeNodes2)):(this.climbNodes=this.generatePointsByPos(e),this.fakeNodes=this.generateFakePointsByPos(t),this.climbNodes2=this.generatePointsRight(this.climbNodes),this.fakeNodes2=this.generateFakePointsRight(this.fakeNodes))},t.prototype.gameStart=function(){var e=this;cc.loader.loadRes("sound/bg",cc.AudioClip,function(e,t){cc.audioEngine.play(t,!0,1)}),this.playerLeft.getComponent(n.default).gameReady(),this.playerRight.getComponent(n.default).gameReady(),this.node.on(cc.Node.EventType.TOUCH_START,this.onTouchStart,this);var t=this.gameCountDown,o=this.background.node.getChildByName("yindao");o.zIndex=2,this.schedule(function(){if(!e.isOver&&(e.gameTimer.string=--t+"",e.playerPos<3&&null==e.yindaoAction.getTarget())){var n=e.climbNodes[e.playerPos];o.setPosition(n.position.x+n.width+50,n.position.y),o.active=!0,o.runAction(e.yindaoAction)}},1,this.gameCountDown-1)},t.prototype.onTouchStart=function(){var e=this,t=this.climbNodes[this.playerPos],o=this.fakeNodes[this.playerPos];if(!(this.playerPos>=this.climbNodes.length||this.isOver))if(this.onClimb(t,o)){this.playerPos+=1,this.progress1.node.width=231*this.playerPos/this.climbNodes.length,this.playerPos>=this.climbNodes.length&&this.player.getComponent(n.default).win().then(function(){e.background.node.runAction(cc.sequence(cc.moveTo(.5,-2048,e.node.height/2),cc.callFunc(function(){var t=e.background.node.getChildByName("box");e.player.getComponent(cc.Animation).play(),t.runAction(cc.moveBy(.5,0,300).easing(cc.easeIn(3)))})))});var i=this.yindaoAction.getTarget();i&&(this.yindaoAction.setTarget(null),i.stopAllActions(),i.active=!1),this.socket.move(this.playerPos)}else this.socket.move(-1)},t.prototype.onClimb=function(e,t){var o=this.player.getComponent(n.default),a=e.position.sub(o.anotherHandPos()).mag(),s=t.position.sub(o.anotherHandPos()).mag();if(console.log(e.position,a),a<=65*e.scale){var c=e.position.sub(this.player.position);o.climbSuccess(e.position);var r=this.background.node.position.x-c.x,d=this.background.node.position.y-c.y;return d<this.node.height/2&&(d=this.node.height/2),this.background.node.runAction(cc.moveTo(.5,r,d)),!0}return s<=65*t.scale?(t.getComponent(i.default).dropDown(),o.dropDown()):o.dropDown(),!1},t.prototype.generatePoints=function(){var e=[];this.stackCount=0;for(var t=0;;t++){var o,n=cc.instantiate(this.pointPrefab);if(n.scale=1+.5*Math.random(),!(o=0==t?this.calculateNewPos(this.playerLeft.position):this.calculateNewPos(e[t-1].position)))break;this.background.node.addChild(n),n.setPosition(o),e.push(n)}return console.log("Total Size",e.length,this.stackCount),e},t.prototype.generatePointsByPos=function(e){for(var t=[],o=0;o<e.length;o++){var n=cc.instantiate(this.pointPrefab),i=e[o];n.scale=i.scale,this.background.node.addChild(n),n.setPosition(i.x,i.y),t.push(n)}return t},t.prototype.generateFakePointsByPos=function(e){for(var t=[],o=0;o<e.length;o++){var n=cc.instantiate(this.pointPrefab2),i=e[o];n.scale=i.scale,this.background.node.addChild(n),n.setPosition(i.x,i.y),t.push(n)}return t},t.prototype.generateFakePoints=function(e){var t=[];this.stackCount=0;for(var o=0;o<e.length;o++){var n,i=new cc.Node("empty"),a=cc.instantiate(this.pointPrefab2);a.scale=1+.5*Math.random(),(n=0==o?this.calculateNewPos(this.playerLeft.position):this.calculateNewPos(e[o-1].position))?e[o].position.sub(n).mag()<=90?t.push(i):t.length>0&&n.sub(t[t.length-1].position).mag()<=90?t.push(i):o>0&&n.sub(e[o-1].position).mag()<=90?t.push(i):o<e.length-1&&n.sub(e[o+1].position).mag()<=90?t.push(i):(this.background.node.addChild(a),a.setPosition(n),t.push(a)):t.push(i)}return t},t.prototype.generatePointsRight=function(e){for(var t=[],o=0;o<e.length;o++){var n=cc.instantiate(this.pointPrefab);n.scale=e[o].scale,this.background.node.addChild(n);var i=e[o].position;n.setPosition(this.playerXSum-i.x,i.y),t.push(n)}return t},t.prototype.generateFakePointsRight=function(e){var t=this,o=[];return e.forEach(function(e){if("empty"!=e.name){var n=cc.instantiate(t.pointPrefab2);n.scale=e.scale,t.background.node.addChild(n),n.setPosition(t.playerXSum-e.position.x,e.position.y),o.push(n)}else o.push(e)}),o},t.prototype.calculateNewPos=function(e){if(this.stackCount++,this.stackCount>1e3)return null;var t=10*(14*Math.random()+2),o=this.background.node.width/2,n=new cc.Vec2;if(n.x=e.x+.8*this.player.width*Math.cos(t*Math.PI/180),n.y=e.y+.8*this.player.width*Math.sin(t*Math.PI/180),n.y>=-1200)return null;if(n.x>=o-.2*this.player.width)return console.log(n),this.calculateNewPos(e);if(n.x<1.2*this.player.width)return console.log(n),this.calculateNewPos(e);var i=Math.round(n.x/2/16),a=-Math.round(n.y/2/16),s=4*(128*(a-1)+i),c=4*(128*(a-1)+Math.round(this.playerXSum/2/16)-i);return 255!=this.wbTexture[s]||255!=this.wbTexture[s+1]||255!=this.wbTexture[s+2]||255!=this.wbTexture[s+3]?(console.log(i,a),this.calculateNewPos(e)):255!=this.wbTexture[c]||255!=this.wbTexture[c+1]||255!=this.wbTexture[c+2]||255!=this.wbTexture[c+3]?(console.log(i,a),this.calculateNewPos(e)):n},__decorate([d(cc.Sprite)],t.prototype,"user1",void 0),__decorate([d(cc.Sprite)],t.prototype,"user2",void 0),__decorate([d(cc.Sprite)],t.prototype,"headFrame",void 0),__decorate([d(cc.Sprite)],t.prototype,"headFrame2",void 0),__decorate([d(cc.Sprite)],t.prototype,"progress1",void 0),__decorate([d(cc.Sprite)],t.prototype,"progress2",void 0),__decorate([d(cc.Label)],t.prototype,"gameTimer",void 0),__decorate([d(cc.Node)],t.prototype,"playerLeft",void 0),__decorate([d(cc.Node)],t.prototype,"playerRight",void 0),__decorate([d(cc.Sprite)],t.prototype,"background",void 0),__decorate([d(cc.Prefab)],t.prototype,"pointPrefab",void 0),__decorate([d(cc.Prefab)],t.prototype,"pointPrefab2",void 0),t=__decorate([r],t)}(a.default));o.default=p,cc._RF.pop()},{"./ClimbPoint":"ClimbPoint","./GameSocket":"GameSocket","./MessageComponent":"MessageComponent","./Player":"Player"}],MessageComponent:[function(e,t,o){"use strict";cc._RF.push(t,"677bdc+rJBO4KhTHrz0qwgc","MessageComponent"),Object.defineProperty(o,"__esModule",{value:!0});var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.myUserId=0,t}return __extends(t,e),t.prototype.onLoad=function(){var e=this;window.addEventListener("message",function(t){switch(console.log("receive message",t.data),t.data.cmd){case"Broadcast":e.onBroadcast(t.data.data);break;case"UpdateData":e.onUpdateUserScore(t.data.data.userId==e.myUserId,t.data.data.userScore);break;case"GameResult":e.onGameOver(t.data.data);break;case"GameBegin":e.myUserId=t.data.data[0].userId,e.onGameBegin(t.data.data,t.data.server)}}),window.parent.postMessage({cmd:"GameLoadReady"},"*")},t.prototype.onBroadcast=function(e){},t.prototype.onGameBegin=function(e,t){},t.prototype.onGameOver=function(e){},t.prototype.onUpdateUserScore=function(e,t){},t.prototype.sendBroadcast=function(e){window.parent.postMessage({cmd:"BroadCastData",uid:this.myUserId,data:e},"*")},t.prototype.sendGameData=function(e,t){t?window.parent.postMessage({cmd:"SendGameData",data:e,uid:t},"*"):window.parent.postMessage({cmd:"SendGameData",data:e},"*")},t.prototype.sendGameOver=function(){window.parent.postMessage({cmd:"GameOver"},"*")},t}(cc.Component);o.default=n,cc._RF.pop()},{}],Player:[function(e,t,o){"use strict";cc._RF.push(t,"88c96DJAp9A/4aBCzfprYGS","Player"),Object.defineProperty(o,"__esModule",{value:!0});var n=cc._decorator,i=n.ccclass,a=(n.property,function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.dropAction=null,t.rotateLeftAction=null,t.rotateRightAction=null,t}return __extends(t,e),t.prototype.onLoad=function(){},t.prototype.gameReady=function(){this.rotateLeftAction=cc.rotateBy(2,-360).repeatForever(),this.rotateRightAction=cc.rotateBy(2,360).repeatForever(),this.node.runAction(this.rotateLeftAction)},t.prototype.dropDown=function(){if(!this.dropAction||!this.dropAction.getTarget()){var e=this.node.y;this.dropAction=cc.sequence(cc.spawn(cc.moveBy(.8,0,e-960-this.node.height).easing(cc.easeOut(1)),cc.rotateBy(.8,360).easing(cc.easeOut(1))),cc.moveTo(.8,this.node.x,e).easing(cc.easeBackOut())),this.node.runAction(this.dropAction)}},t.prototype.climbSuccess=function(e){this.node.stopAllActions(),this.changeAnchor(),this.node.setPosition(e),this.node.runAction(.1==this.node.anchorX?this.rotateLeftAction:this.rotateRightAction)},t.prototype.changeAnchor=function(){var e=this,t=.1==this.node.anchorX?.9:.1;this.node.children.forEach(function(o){var n=(.1==t?1:-1)*e.node.width*.8;o.setPosition(o.position.x+n,o.position.y)}),this.node.anchorX=t},t.prototype.win=function(){var e=this;return new Promise(function(t,o){var n;e.node.stopAllActions();var i=(e.node.rotation%360+360)%360;e.node.setRotation(i),console.log(i,e.node.position);var a=.1==e.node.anchorX,s=cc.rotateBy(.5,a?-i:360-i).easing(cc.easeIn(1));n=new cc.Vec2(2048-.4*e.node.width*(a?1:-1),-800);var c=cc.moveTo(.5,n).easing(cc.easeBackIn());e.node.runAction(cc.sequence(cc.spawn(s,c),cc.callFunc(function(){.1!=e.node.anchorX&&(e.changeAnchor(),e.node.setPosition(e.node.position.x-.8*e.node.width,e.node.position.y)),t()})))})},t.prototype.anotherHandPos=function(){var e=.1==this.node.anchorX?.9:.1,t=(360-this.node.rotation)*Math.PI/180,o=(e-this.node.anchorX)*this.node.width*Math.cos(t),n=(e-this.node.anchorX)*this.node.width*Math.sin(t);return new cc.Vec2(this.node.position.x+o,this.node.position.y+n)},t.prototype.start=function(){},t.prototype.onDestroy=function(){},t=__decorate([i],t)}(cc.Component));o.default=a,cc._RF.pop()},{}]},{},["ClimbPoint","GameSocket","GameView","MessageComponent","Player"]);